#!/bin/sh
set -e

for PLUG in %PLUGS%; do
  if ! snapctl is-connected ${PLUG}
  then
    echo "WARNING: ${PLUG} interface not connected! Please run: /snap/%SNAP%/current/bin/setup.sh"
  fi
done

real_xdg_runtime_dir=$(dirname "${XDG_RUNTIME_DIR}")
real_wayland=${real_xdg_runtime_dir}/${WAYLAND_DISPLAY:-wayland-0}

if [ ! -O "${real_wayland}" ]; then
  # On core systems mir-kiosk may also need to create the host XDG_RUNTIME_DIR
  if [ ! -O "${real_xdg_runtime_dir}" ]; then
    echo waiting for host XDG_RUNTIME_DIR...
    until [ -O "${real_xdg_runtime_dir}" ]
    do
      inotifywait --event create "$(dirname "${real_xdg_runtime_dir}")" || sleep 4
    done
  fi

  echo waiting for Wayland socket...
  until [ -O "${real_wayland}" ]
  do
    inotifywait --event create "$(dirname "${real_wayland}")" || sleep 4
  done

  echo "...waiting done"
fi

mkdir -p "$XDG_RUNTIME_DIR" -m 700
ln -sf "${real_wayland}" "$XDG_RUNTIME_DIR"
ln -sf "${real_wayland}.lock" "$XDG_RUNTIME_DIR"
unset DISPLAY

exec "$@"
