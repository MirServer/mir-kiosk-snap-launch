#!/bin/sh

set -x

if ! snapctl is-connected wayland
then
  echo "Wayland interface not connected!"
  exit 1
fi

real_xdg_runtime_dir=$(dirname "${XDG_RUNTIME_DIR}")
real_wayland=${real_xdg_runtime_dir}/${WAYLAND_DISPLAY:-wayland-0}

while [ ! -O "${real_wayland}" ]
do
  # On core systems mir-kiosk may also need to create the host XDG_RUNTIME_DIR
  while [ ! -O "${real_xdg_runtime_dir}" ]
  do
    echo waiting for host XDG_RUNTIME_DIR
    inotifywait --event create $(dirname "${real_xdg_runtime_dir}") || sleep 4
  done

  echo waiting for Wayland socket
  inotifywait --event create $(dirname "${real_wayland}") || sleep 4
done

mkdir -p "$XDG_RUNTIME_DIR" -m 700
ln -sf "${real_wayland}" "$XDG_RUNTIME_DIR"
unset DISPLAY

exec "$@"
